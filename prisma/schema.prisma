datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  CUSTOMER
  EXECUTOR
}

enum TaskType {
  SERVICE_REQUEST
  SERVICE_OFFER
}

enum TaskStatus {
  DRAFT
  ACTIVE
  PAUSED
  DONE
  CANCELED
}

model User {
  id              String   @id @default(cuid())
  tgId            String   @unique
  username        String?  @db.VarChar(32)
  role            UserRole @default(EXECUTOR)
  ratingAsExec    Float    @default(0)
  ratingAsCust    Float    @default(0)
  createdAt       DateTime @default(now())
  tasks           Task[]   @relation("AuthorTasks")
  responses       Response[]
  reviewsGiven    Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")
  skills          UserSpecialization[]
}

model Category {
  id              String           @id @default(cuid())
  slug            String           @unique
  title           String
  active          Boolean          @default(true)
  sort            Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  specializations Specialization[]
  tasks           Task[]

  @@index([active, sort])
}

model Specialization {
  id         String               @id @default(cuid())
  categoryId String
  category   Category             @relation(fields: [categoryId], references: [id])
  slug       String               @unique
  title      String
  active     Boolean              @default(true)
  sort       Int                  @default(0)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  tasks      TaskSpecialization[]
  users      UserSpecialization[]

  @@index([categoryId, active, sort])
}

model TaskSpecialization {
  taskId           String
  specializationId String
  task             Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  specialization   Specialization @relation(fields: [specializationId], references: [id])

  @@id([taskId, specializationId])
  @@index([specializationId])
}

model UserSpecialization {
  userId           String
  specializationId String
  level            Int?
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization   Specialization @relation(fields: [specializationId], references: [id])

  @@id([userId, specializationId])
  @@index([specializationId])
}

model Task {
  id          String               @id @default(cuid())
  authorId    String
  author      User                 @relation("AuthorTasks", fields: [authorId], references: [id])
  categoryId  String
  category    Category             @relation(fields: [categoryId], references: [id])
  type        TaskType
  status      TaskStatus           @default(ACTIVE)
  title       String               @db.VarChar(140)
  description String               @db.Text
  budgetMin   Int?
  budgetMax   Int?
  currency    String               @default("USDT")
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  attachments Attachment[]
  responses   Response[]
  reviews     Review[]
  specs       TaskSpecialization[]

  @@index([type, status, createdAt])
  @@index([authorId])
  @@index([categoryId, status, createdAt])
}

model Attachment {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  url    String
  mime   String
}

model Response {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  text      String   @db.Text
  price     Int?
  createdAt DateTime @default(now())

  @@unique([taskId, userId])
}

model Review {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  taskId     String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  fromUser   User     @relation("ReviewsGiven", fields: [fromUserId], references: [id])
  toUser     User     @relation("ReviewsReceived", fields: [toUserId], references: [id])
  task       Task     @relation(fields: [taskId], references: [id])

  @@index([toUserId, rating])
}
